{% extends 'layout.html' %}
{% block content %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% load humanize %}

<script>
    window.chartData = JSON.parse('{{ chart_data|escapejs }}');
    window.topCategoryData = JSON.parse('{{ top_category_json|escapejs }}');
</script>
<style>
  
  .dashboard {
    padding: 1.5rem;
    max-width: 100%;
    background: var(--bg);
    min-height: 100vh;
  }

  /* Clean Header */
  .dash-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem 0;
  }

  .dash-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
  }

  .dash-date {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .dash-actions {
    display: flex;
    gap: 0.75rem;
  }

  .btn-primary {
    background: var(--accent);
    border: none;
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    a{
      color: white;
      text-decoration: none;
      transition: all 0.2s;
      font-weight: 500;
    }
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-secondary {
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    a{
      color: var(--text);
      text-decoration: none;
      transition: all 0.2s;
      font-weight: 500;
    }
  }

  .btn-secondary:hover {
    background: var(--card);
  }

  /* Simple Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    transition: all 0.2s;
    cursor: pointer;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
  }

  .stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .stat-label {
    font-size: 0.85rem;
    color: var(--muted);
    font-weight: 500;
  }

  .stat-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: white;
  }

  .stat-value {
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.25rem;
  }

  .stat-change {
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .positive { color: var(--success); }
  .negative { color: var(--danger); }
  .neutral { color: var(--muted); }

  /* Card Colors */
  .income .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
  .expense .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
  .balance .stat-icon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
  .savings .stat-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

  /* Main Content Grid */
  .content-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  /* Chart Section */
  .chart-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .chart-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
  }

  .chart-tabs {
    display: flex;
    gap: 0.5rem;
    margin-left: auto;
  }

  .tab-btn {
    background: none;
    border: none;
    color: var(--muted);
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn.active,
  .tab-btn:hover {
    background: var(--accent);
    color: white;
  }

  .chart-container {
    height: 300px;
    position: relative;
  }

  /* Quick Stats Panel */
  .quick-stats {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .quick-stats h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 1rem;
  }

  .quick-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
  }

  .quick-item:last-child {
    border-bottom: none;
  }

  .quick-label {
    font-size: 0.85rem;
    color: var(--muted);
  }

  .quick-value {
    font-weight: 600;
    color: var(--text);
  }

  /* Advanced Features */
  .advanced-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .feature-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    position: relative;
    overflow: hidden;
  }

  .feature-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--feature-accent);
  }

  .feature-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .feature-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: var(--feature-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.1rem;
  }

  .feature-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
  }

  .feature-content {
    color: var(--muted);
    font-size: 0.9rem;
    line-height: 1.4;
  }

  /* Feature Colors */
  .ai-insights { --feature-accent: linear-gradient(135deg, #8b5cf6, #7c3aed); }
  .auto-categorize { --feature-accent: linear-gradient(135deg, #10b981, #059669); }
  .budget-planner { --feature-accent: linear-gradient(135deg, #f59e0b, #d97706); }
  .investment-tracker { --feature-accent: linear-gradient(135deg, #3b82f6, #2563eb); }

  /* Smart Transactions */
  .transactions {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .transactions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .transactions-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
  }
  .transaction-avatar {
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.transaction-income { background-color: #10b981; }
.transaction-category-food { background-color: #f59e0b; }
.transaction-category-transport { background-color: #3b82f6; }
.transaction-category-utilities { background-color: #ef4444; }
/* Add more category styles as needed */
  .search-box {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    color: var(--text);
    font-size: 0.85rem;
    width: 200px;
  }

  .search-box:focus {
    outline: none;
    border-color: var(--accent);
  }

  .transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
    transition: all 0.2s;
  }

  .transaction-item:hover {
    background: var(--panel);
    margin: 0 -1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border-bottom: 1px solid transparent;
  }

  .transaction-item:last-child {
    border-bottom: none;
  }

  .transaction-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  /* .transaction-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: white;
    font-weight: 600;
  } */

  .transaction-details h4 {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text);
    margin: 0 0 0.1rem 0;
  }

  .transaction-details p {
    font-size: 0.75rem;
    color: var(--muted);
    margin: 0;
  }

  .transaction-amount {
    font-weight: 600;
    font-size: 0.9rem;
  }

  /* AI Chat Assistant */
  .ai-chat {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
    scrollbar-width: none;
    scroll-behavior: smooth;
  }

  .chat-toggle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    transition: all 0.3s;
  }

  .chat-toggle:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
  }

  .chat-window {
    position: absolute;
    bottom: 70px;
    right: 0;
    width: 320px;
    height: 400px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-header {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: white;
    padding: 1rem;
    font-weight: 600;
  }

  .chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    scrollbar-width: none;
    scroll-behavior: smooth;
  }

  .chat-message {
    margin-bottom: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    max-width: 80%;
    scrollbar-width: none;
    scroll-behavior: smooth;
    color: #fff;
  }

  .chat-message .ai {
    background: var(--panel);
    color: #fff;
    margin-right: auto;
  }

  .chat-message .user {
    background: var(--accent);
    color: white;
    margin-left: auto;
  }
  .message{ margin: 5px 0; }
  .user{text-align: right;}
  .chat-input {
    padding: 1rem;
    border-top: 1px solid var(--border);
  }

  .chat-input input {
    width: 100%;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem;
    color: #fff;
    font-size: 0.85rem;
  }

  .chat-input input:focus {
    outline: none;
    border-color: var(--accent);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .dashboard {
      padding: 1rem;
    }

    .dash-header {
      flex-direction: column;
      gap: 1rem;
      text-align: center;
    }

    .content-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .advanced-section {
      grid-template-columns: 1fr;
    }

    .search-box {
      width: 150px;
    }

    .ai-chat {
      bottom: 1rem;
      right: 1rem;
    }

    .chat-window {
      width: 280px;
      height: 350px;
    }
  }

  @media (max-width: 480px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .dash-actions {
      flex-direction: column;
      width: 100%;
    }

    .btn-primary,
    .btn-secondary {
      justify-content: center;
    }
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .stat-card,
  .feature-card {
    animation: fadeIn 0.3s ease-out;
  }

  .stat-card:nth-child(1) { animation-delay: 0.1s; }
  .stat-card:nth-child(2) { animation-delay: 0.2s; }
  .stat-card:nth-child(3) { animation-delay: 0.3s; }
  .stat-card:nth-child(4) { animation-delay: 0.4s; }

  /* Loading States */
  .loading {
    opacity: 0.7;
    pointer-events: none;
    position: relative;
  }

  .loading::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 1.5s infinite;
  }

  /* Transaction Modal Styles */
  .transaction-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .transaction-modal.show {
    opacity: 1;
    visibility: visible;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 0;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.9);
    transition: transform 0.3s ease;
    position: relative;
  }

  .transaction-modal.show .modal-content {
    transform: scale(1);
  }

  .modal-header {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: white;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
  }

  .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .transaction-form {
    padding: 2rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--text);
    font-size: 0.9rem;
    transition: border-color 0.2s;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(var(--accent-rgb, 74, 168, 255), 0.1);
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    justify-content: flex-end;
  }

  .btn-cancel {
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-cancel:hover {
    background: var(--card);
  }

  .btn-add {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-add:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(var(--accent-rgb, 74, 168, 255), 0.3);
  }

  .btn-add:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  /* New Transaction Animation */
  .new-transaction {
    background: rgba(var(--accent-rgb, 74, 168, 255), 0.1);
    border: 1px solid var(--accent);
    border-radius: 8px;
    animation: slideInNew 0.5s ease-out;
  }

  @keyframes slideInNew {
    from {
      opacity: 0;
      transform: translateX(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  /* Notification Styles */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    z-index: 1001;
    display: flex;
    align-items: center;
    gap: 1rem;
    min-width: 300px;
    animation: slideInNotification 0.3s ease-out;
  }

  .notification.success {
    border-left: 4px solid var(--success);
  }

  .notification.error {
    border-left: 4px solid var(--danger);
  }

  .notification-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
  }

  .notification-content i {
    color: var(--success);
    font-size: 1.1rem;
  }

  .notification.error .notification-content i {
    color: var(--danger);
  }

  .notification-content span {
    color: var(--text);
    font-weight: 500;
  }

  .notification button {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .notification button:hover {
    background: var(--panel);
    color: var(--text);
  }

  @keyframes slideInNotification {
    from {
      opacity: 0;
      transform: translateX(100%);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Mobile Modal Responsive */
  @media (max-width: 768px) {
    .modal-content {
      width: 95%;
      margin: 1rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .transaction-form {
      padding: 1.5rem;
    }

    .notification {
      left: 20px;
      right: 20px;
      min-width: unset;
    }
    canvas{
      height: 300px;
    }
  }
</style>

<div class="dashboard">
  <!-- Clean Header -->
  <div class="dash-header">
    <div>
      <h1 class="dash-title">Financial Overview</h1>
      <div class="dash-date">Today, {% now "F d, Y" %}</div>
    </div>
    <div class="dash-actions">
      <button class="btn-primary">
        <i class="fas fa-plus"></i>
        <a href="{% url 'transaction' %}" style="color: white; text-decoration: none;">Add Transaction</a>
      </button>
      <button class="btn-secondary">
        <i class="fas fa-download"></i>
        <a href="{% url 'export_csv' %}" style="color: #333; text-decoration: none;">Export</a>
      </button>
    </div>
  </div>

  <!-- Simple Stats -->
  <div class="stats-grid">
    <div class="stat-card income">
      <div class="stat-header">
        <span class="stat-label">Total Income</span>
        <div class="stat-icon">
          <i class="fas fa-arrow-up"></i>
        </div>
      </div>
      <div class="stat-value">₦{{ monthly_income|floatformat:2|intcomma }}</div>
      <div class="stat-change {% if income_trend > 0 %}positive{% else %}negative{% endif %}">
        <i class="fas fa-arrow-{% if income_trend > 0 %}up{% else %}down{% endif %}"></i>
        {{ income_trend|floatformat:1 }}% this month
      </div>
    </div>

    <div class="stat-card expense">
      <div class="stat-header">
        <span class="stat-label">Total Expenses</span>
        <div class="stat-icon">
          <i class="fas fa-arrow-down"></i>
        </div>
      </div>
      <div class="stat-value">₦{{ monthly_expenses|floatformat:2|intcomma }}</div>
      <div class="stat-change {% if expense_trend < 0 %}positive{% else %}negative{% endif %}">
        <i class="fas fa-arrow-{% if expense_trend < 0 %}down{% else %}up{% endif %}"></i>
        {{ expense_trend|floatformat:1 }}% this month
      </div>
    </div>

    <div class="stat-card balance">
      <div class="stat-header">
        <span class="stat-label">Net Balance</span>
        <div class="stat-icon">
          <i class="fas fa-wallet"></i>
        </div>
      </div>
      <div class="stat-value">₦{{ net_balance|floatformat:2|intcomma }}</div>
      <div class="stat-change {% if net_balance > 0 %}positive{% else %}negative{% endif %}">
        <i class="fas fa-arrow-{% if net_balance > 0 %}up{% else %}down{% endif %}"></i>
        {% if net_balance > 0 %}+{% endif %}{{ net_balance|floatformat:2|intcomma }}
      </div>
    </div>

    <div class="stat-card savings">
      <div class="stat-header">
        <span class="stat-label">Savings Progress</span>
        <div class="stat-icon">
          <i class="fas fa-piggy-bank"></i>
        </div>
      </div>
      <div class="stat-value">{{ savings_progress|floatformat:0 }}%</div>
      <div class="stat-change">
        <i class="fas fa-target"></i>
        ₦{{ total_balance|floatformat:2|intcomma }} of ₦{{ savings_goal|floatformat:2|intcomma }}
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-grid">
    <div class="chart-section">
      <div class="chart-header">
        <h2 class="chart-title">Spending Analysis</h2>
        <div class="chart-tabs">
          <button class="tab-btn active" data-period="week">Week</button>
          <button class="tab-btn" data-period="month">Month</button>
          <button class="tab-btn" data-period="year">Year</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="mainChart"></canvas>
      </div>
    </div>

    <div class="quick-stats">
      <h3><i class="fas fa-bolt"></i> Quick Insights</h3>
      <div class="quick-item">
        <span class="quick-label">Top Spending Category</span>
        <span class="quick-value" data-stat="top-category">
          {% if top_categories.0 %}
            {{ top_categories.0.category|title }}: ₦{{ top_categories.0.total|floatformat:2|intcomma }}
          {% else %}
            No spending data
          {% endif %}
        </span>
      </div>
      <div class="quick-item">
        <span class="quick-label">Accounts Balance</span>
        <span class="quick-value" data-stat="total-balance">
          ₦{{ total_balance|floatformat:2|intcomma }}
        </span>
      </div>
      <div class="quick-item">
        <span class="quick-label">Monthly Cash Flow</span>
        <span class="quick-value {% if net_cash_flow > 0 %}positive{% else %}negative{% endif %}" data-stat="cash-flow">
          {% if net_cash_flow > 0 %}+{% endif %}₦{{ net_cash_flow|floatformat:2|intcomma }}
        </span>
      </div>
      <div class="quick-item">
        <span class="quick-label">Emergency Fund</span>
        <span class="quick-value" data-stat="emergency-fund">
          {{ emergency_fund_months|floatformat:1 }} months
        </span>
      </div>
      <div class="quick-item">
        <span class="quick-label">Savings Rate</span>
        <span class="quick-value {% if savings_rate > 0 %}positive{% else %}negative{% endif %}" data-stat="savings-rate">
          {{ savings_rate|floatformat:1 }}%
        </span>
      </div>
            <div class="quick-item">
        <span class="quick-label">Expenditure Ability</span>
        <span class="quick-value {% if expenditure_rating > 0 %}positive{% else %}negative{% endif %}" data-stat="expenditure-ability" style="font-size: 0.5rem;">
          {{ expenditure_rating }}
        </span>
      </div>
    </div>
  </div>

  <!-- Smart Transactions -->
  <div class="transactions">
    <div class="transactions-header">
      <h2 class="transactions-title">Recent Activity</h2>
      <input type="text" class="search-box" placeholder="Search transactions..." id="searchBox">
    </div>
    
    <div id="transactionList">
      {% for transaction in recent_transactions %}
      <div class="transaction-item" data-category="{{ transaction.category }}" data-amount="{{ transaction.amount }}">
        <div class="transaction-info">
          <div class="transaction-avatar transaction.color" style="color: white;">
            {{ transaction.description.0|upper }}
          </div>

          <div class="transaction-details">
            <h4>{{ transaction.description }}</h4>
            <p>{{ transaction.date|date:"M d" }} • {{ transaction.category|title }} • {{ transaction.account.name }}</p>
          </div>
        </div>
        <div class="transaction-amount {% if transaction.transaction_type == 'income' %}positive{% else %}negative{% endif %}">
          {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}₦{{ transaction.amount|floatformat:2|intcomma }}
        </div>
      </div>
      {% empty %}
      <div class="no-transactions">
        <i class="fas fa-receipt"></i>
        <p>No recent transactions found.</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- AI Chat Assistant -->
  <div class="ai-chat">
    <button class="chat-toggle" onclick="toggleChat()">
      <i class="fas fa-robot" id="chatIcon"></i>
    </button>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <i class="fas fa-robot"></i> Financial Assistant
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message ai">
          Hi! I'm your AI financial assistant. I can help you analyze spending, set budgets, and answer questions about your finances. What would you like to know?
        </div>
      </div>
      <div class="user" style="margin:23px; cursor: pointer;" onclick="clearChat()">
        <i class="fas fa-trash"></i>
      </div>
      <div class="chat-input">
        <input type="text" placeholder="Ask me anything..." id="chatInput" onkeypress="handleChatInput(event)">
      </div>
    </div>
  </div>

  <!-- Error Display -->
  {% if error %}
  <div class="error-message">
    <i class="fas fa-exclamation-triangle"></i>
    <p>Error loading dashboard: {{ error }}</p>
  </div>
  {% endif %}
</div>

<!-- Add Transaction Modal -->
<div class="transaction-modal" id="transactionModal">
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add Transaction</h3>
      <button onclick="closeModal()" class="close-btn">&times;</button>
    </div>
    <form class="transaction-form" id="transactionForm">
      {% csrf_token %}
      <div class="form-row">
        <div class="form-group">
          <label>Amount</label>
          <input type="number" name="amount" placeholder="0.00" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Type</label>
          <select name="type" required>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" name="description" placeholder="What was this for?" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Category</label>
          <select name="category" required>
            <option value="">Select category</option>
            <option value="food">Food & Dining</option>
            <option value="transport">Transportation</option>
            <option value="utilities">Utilities</option>
            <option value="entertainment">Entertainment</option>
            <option value="shopping">Shopping</option>
            <option value="healthcare">Healthcare</option>
            <option value="salary">Salary</option>
            <option value="freelance">Freelance</option>
            <option value="investment">Investment</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Account</label>
          <select name="account" required>
            {% for account in accounts %}
            <option value="{{ account.id }}">{{ account.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" onclick="closeModal()" class="btn-cancel">Cancel</button>
        <button type="submit" class="btn-add">Add Transaction</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
  // =========================
// Transactions
// =========================
function addTransaction(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const submitBtn = form.querySelector('.btn-add');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    submitBtn.disabled = true;

    fetch("/add-transaction/", {   // ✅ use Django URL mapping
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            account_id: formData.get('account'),
            amount: parseFloat(formData.get('amount')),
            type: formData.get('type'),
            description: formData.get('description'),
            category: formData.get('category')
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            closeModal();
            updateDashboardAfterTransaction(data.transaction);
            showNotification(data.message, 'success');
            form.reset();
        } else {
            showNotification('Error: ' + data.message, 'error');
            submitBtn.innerHTML = 'Add Transaction';
            submitBtn.disabled = false;
        }
    })
    .catch(() => {
        showNotification('Error adding transaction', 'error');
        submitBtn.innerHTML = 'Add Transaction';
        submitBtn.disabled = false;
    });
}

function exportData(event) {
    const btn = event.target;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    btn.disabled = true;
    window.location.href = "/export-csv/";
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-download"></i> Export';
        btn.disabled = false;
    }, 2000);
}

// =========================
// Chat
// =========================
function toggleChat() {
    const chatWindow = document.getElementById("chatWindow");
    chatWindow.style.display = (chatWindow.style.display === "none") ? "flex" : "none";
}

async function handleChatInput(event) {
    if (event.key === "Enter") {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML += `<div class="user message">${message}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        input.value = "";

        const loading = document.createElement("div");
        loading.textContent = "please wait....";
        chatMessages.appendChild(loading);

        try {
            const response = await fetch("/api/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: message })
            });

            const data = await response.json();
            loading.remove();

            if (data.reply) {
                chatMessages.innerHTML += `<div class="message ai">${data.reply}</div>`;
            } else {
                chatMessages.innerHTML += `<div class="message ai" style="color:red;">Error: ${data.error}</div>`;
            }
        } catch (error) {
            loading.remove();
            chatMessages.innerHTML += `<div class="message ai" style="color:red;">Error: ${error}</div>`;
        }
    }
}

function clearChat() {
    const chatMessages = document.getElementById("chatMessages");
    chatMessages.innerHTML = `<div class="chat-message ai">
        Hi! I'm your AI financial assistant. I can help you analyze spending, set budgets, and answer questions about your finances. What would you like to know?
    </div>`;
}

// =========================
// Transactions filter
// =========================
function filterTransactions() {
    const searchTerm = document.getElementById('searchBox').value.toLowerCase();
    document.querySelectorAll('.transaction-item').forEach(tx => {
        tx.style.display = tx.textContent.toLowerCase().includes(searchTerm) ? 'flex' : 'none';
    });
}

// =========================
// Charts
// =========================
const chartData = window.chartData;
let mainChart = null;

function setupChartTabs() {
    const tabButtons = document.querySelectorAll('.chart-tabs .tab-btn');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            switchChart(this.dataset.period);
        });
    });
}

function initializeChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    const initialData = chartData.week;

    mainChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: initialData.labels,
            datasets: [
                { label: 'Income', data: initialData.income, backgroundColor: '#10b981' },
                { label: 'Expenses', data: initialData.expenses, backgroundColor: '#ef4444' }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => ctx.dataset.label + ': ₦' + ctx.raw.toLocaleString('en-NG')
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: val => '₦' + val.toLocaleString('en-NG')
                    }
                }
            }
        }
    });
}

function switchChart(period) {
    if (!chartData[period]) return console.error("No data:", period);
    const data = chartData[period];
    mainChart.data.labels = data.labels;
    mainChart.data.datasets[0].data = data.income;
    mainChart.data.datasets[1].data = data.expenses;
    mainChart.config.type = (period === 'year') ? 'line' : 'bar';
    mainChart.update();
}

// =========================
// Quick stats
// =========================
function updateQuickStats() {
    const cat = window.topCategoryData;
    document.querySelector('[data-stat="top-category"]').textContent =
        `${cat.category}: ₦${cat.amount.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
    document.querySelector('[data-stat="total-balance"]').textContent =
        `₦${window.totalBalance.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
    document.querySelector('[data-stat="cash-flow"]').textContent =
        `₦${window.netCashFlow.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
    document.querySelector('[data-stat="emergency-fund"]').textContent =
        `${window.emergencyFundMonths} months`;
    document.querySelector('[data-stat="savings-rate"]').textContent =
        `${window.savingsRate}%`;
}

// =========================
// Utilities
// =========================
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function closeModal() {
    document.getElementById('transactionModal').style.display = 'none';
}

function updateDashboardAfterTransaction(tx) {
    console.log('Transaction added:', tx);
    window.location.reload(); // quick way to refresh
}

// =========================
// Init
// =========================
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('transactionForm');
    if (form) form.addEventListener('submit', addTransaction);

    if (document.getElementById('mainChart')) {
        initializeChart();
        setupChartTabs();
    }

    const searchBox = document.getElementById('searchBox');
    if (searchBox) searchBox.addEventListener('input', filterTransactions);

    updateQuickStats();

    document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('mouseenter', () => card.style.transform = 'translateY(-5px)');
        card.addEventListener('mouseleave', () => card.style.transform = 'translateY(0)');
    });

    window.addEventListener('load', () => document.body.classList.add('loaded'));
});

</script>
{% endblock %}