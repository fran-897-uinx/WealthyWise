{% extends "layout.html" %} 
{% block content %} 
{% load static %}

<link rel="stylesheet" href="{% static 'css/transaction.css' %}">
<script id="chart-data" type="application/json">
  {{ chart_data|safe }}
</script>
<div class="transaction_app">
  <div class="container-fluid">
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Header -->
    <header class="header fade-in">
      <div class="brand">
        <div class="logo">
          {% if user.profile.avatar %}
              <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
          {% else %}
              <div class="avatar-placeholder">{{ user.profile.get_initials }}</div>
          {% endif %}
        </div>
        <h1>Transaction Dashboard</h1>
      </div>
      <div class="header-actions">
        <a href="{% url 'export_csv' %}" class="btn btn-secondary">ğŸ“Š Export CSV</a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
          â• Add Transaction
        </button>
      </div>
    </header>

    <!-- Summary Statistics -->
    <section class="summary-stats">
      <div class="card stat-card fade-in" style="animation-delay: 0.1s">
        <h3>ğŸ’° Total Balance</h3>
        <div class="stat-value" id="totalBalance">â‚¦{{ total_balance }}</div>
        <div class="stat-trend">Across {{ accounts|length }} account{{ accounts|pluralize }}</div>
      </div>
      
      <div class="card stat-card fade-in" style="animation-delay: 0.2s">
        <h3>ğŸ“ˆ This Month â€” Income</h3>
        <div class="stat-value trend-up" id="monthIncome">â‚¦{{ monthly_income|floatformat:2 }}</div>
        <div class="stat-trend trend-up">+12% vs last month</div>
      </div>
      
      <div class="card stat-card fade-in" style="animation-delay: 0.3s">
        <h3>ğŸ“‰ This Month â€” Expenses</h3>
        <div class="stat-value trend-down" id="monthExpense">â‚¦{{ monthly_expenses|floatformat:2 }}</div>
        <div class="stat-trend trend-down">+5% vs last month</div>
      </div>
      
      <div class="card stat-card fade-in" style="animation-delay: 0.4s">
        <h3>ğŸ“Š Budgets Used</h3>
        {% if budget_usage %}
          {% with budget_usage.0 as first_budget %}
            <div class="stat-value">{{ first_budget.percent }}%</div>
          {% endwith %}
          <div class="stat-trend">
            {% for b in budget_usage %}
              {{ b.category }} {{ b.percent }}%{% if not forloop.last %} â€¢ {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="stat-value">No Budgets Set</div>
        {% endif %}
      </div>
    </section>

    <!-- Accounts -->
    <section class="accounts-grid">
      {% for account in accounts %}
      <div class="card account-card fade-in" style="--animation-delay: {{ forloop.counter|add:0.1 }}s">
        <div class="status-indicator"></div>
        <div class="account-header">
          <span class="account-name">
            {% if account.account_type == 'savings' %}ğŸ¦
            {% elif account.account_type == 'business' %}ğŸ’¼
            {% else %}ğŸ’µ
            {% endif %} 
            {{ account.name }}
          </span>
          <span class="account-badge">{{ account.get_account_type_display }}</span>
        </div>
        <div class="account-balance" id="{{ account.id }}-balance">â‚¦{{ account.balance|floatformat:2 }}</div>
        <div class="account-meta">
          Currency: {{ account.currency }} â€¢ Last updated: {{ account.updated_at|date:"d M Y" }}
        </div>
      </div>
      {% endfor %}
    </section>

    <!-- Chart and Transactions -->
    <section class="container-fluid gap-4 d-flex flex-column">
      <div class="card content-panel fade-in" style="animation-delay: 0.8s">
        <h3 class="panel-title">ğŸ“ˆ Account Balances Overview</h3>
        <canvas id="balanceChart"></canvas>
      </div>

      <div class="card content-panel fade-in" style="animation-delay: 0.9s">
        <h3 class="panel-title">ğŸ”„ Recent Transactions</h3>
        <div class="table-container">
          <table class="transactions-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Account</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              {% for transaction in recent_transactions %}
              <tr>
                <td>{{ transaction.date|date:"d M" }}</td>
                <td class="{% if transaction.transaction_type == 'income' %}transaction-income{% else %}transaction-expense{% endif %}">
                  {% if transaction.transaction_type == 'income' %}ğŸ“ˆ Income
                  {% else %}ğŸ“‰ Expense{% endif %}
                </td>
                <td>{{ transaction.description }}</td>
                <td class="{% if transaction.transaction_type == 'income' %}amount-positive{% else %}amount-negative{% endif %}">
                  {% if transaction.transaction_type == 'income' %}â‚¦
                  {% else %}-â‚¦{% endif %}{{ transaction.amount|floatformat:2 }}
                </td>
                <td>{{ transaction.account.name }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Add Transaction Modal -->
  <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title" id="addTransactionModalLabel">
            <i class="fas fa-plus-circle me-2"></i>
            Add New Transaction
          </h1>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form id="transactionForm" method="post" data-url="{% url 'add_transaction' %}">
          {% csrf_token %}
          <div class="modal-body text-success">

            <!-- Transaction Type -->
            <div class="form-group">
              <label class="form-label">Transaction Type</label>
              <div class="transaction-type-cards">
                <div class="type-card income text-success" data-type="income">
                  <i class="fas fa-arrow-up"></i><h6>Income</h6>
                </div>
                <div class="type-card expense text-danger" data-type="expense">
                  <i class="fas fa-arrow-down"></i><h6>Expense</h6>
                </div>
              </div>
              <input type="hidden" id="transactionType" name="transaction_type" required />
            </div>

            <div class="row">
              <!-- Account -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="account" class="form-label">Account</label>
                  <select class="form-select" id="account" name="account" required>
                    <option value="">Select Account</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- Amount -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="amount" class="form-label">Amount</label>
                  <div class="amount-input-group">
                    <span class="currency-symbol">â‚¦</span>
                    <input type="number" class="form-control amount-input" id="amount" name="amount" placeholder="0.00" step="0.01" min="0" required />
                  </div>
                </div>
              </div>
            </div>

            <!-- Description -->
            <div class="form-group">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3" placeholder="Enter transaction description..." required></textarea>
            </div>

            <!-- Category (Dynamic from DB) -->
            <div class="form-group">
    <label for="category" class="form-label">Category</label>
    <select class="form-select" id="category" name="category" required>
        <option value="">Select Category</option>
        {% for value, label in transaction_categories %}
            <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
    </select>
</div>

            <!-- Date -->
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="transactionDate" class="form-label">Transaction Date</label>
                  <input type="date" class="form-control" id="transactionDate" name="transaction_date" required />
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Transaction</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="{% static 'js/transaction.js' %}"></script>

{% endblock %}
