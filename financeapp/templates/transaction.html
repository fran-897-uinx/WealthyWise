{% extends "layout.html" %} {% block content %} 
{% load static %}

<script id="chart-data" type="application/json">
  {{ chart_data|safe }}
</script>

<style>
  /* =======================
   Dashboard & Cards
   ======================= */
  .transaction_app {
    padding: 1rem;
    font-family: system-ui, sans-serif;
  }
  .fade-in {
    opacity: 0;
    animation: fadeIn 0.6s forwards;
  }
  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  .card {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    padding: 1rem;
    margin-bottom: 1rem;
    transition: transform 0.2s ease;
  }
  .card:hover {
    transform: translateY(-2px);
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
  }
  .avatar-placeholder {
    background: #ddd;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
  }
  .header-actions .btn {
    margin-left: 0.5rem;
  }

  /* =======================
   Stats section
   ======================= */
  .summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .stat-card {
    text-align: left;
  }
  .stat-value {
    font-size: 1.4rem;
    font-weight: 700;
  }
  .trend-up {
    color: green;
  }
  .trend-down {
    color: red;
  }

  /* =======================
   Accounts
   ======================= */
  .accounts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .account-card {
    position: relative;
  }
  .status-indicator {
    width: 8px;
    height: 8px;
    background: green;
    border-radius: 50%;
    position: absolute;
    top: 10px;
    left: 10px;
  }
  .account-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  .account-badge {
    background: #eee;
    padding: 0.2rem 0.5rem;
    border-radius: 0.5rem;
    font-size: 0.8rem;
  }
  .account-balance {
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }
  .account-meta {
    font-size: 0.8rem;
    color: #666;
  }

  /* =======================
   Table
   ======================= */
  .transactions-table {
    width: 100%;
    border-collapse: collapse;
  }
  .transactions-table th,
  .transactions-table td {
    padding: 0.5rem;
    border-bottom: 1px solid #eee;
    text-align: left;
  }
  .transaction-income {
    color: green;
  }
  .transaction-expense {
    color: red;
  }
  .amount-positive {
    color: green;
  }
  .amount-negative {
    color: red;
  }

  /* =======================
   Modal & Form
   ======================= */
  .modal-content {
    border-radius: 1rem;
  }
  .form-group {
    margin-bottom: 1rem;
  }
  .transaction-type-cards {
    display: flex;
    gap: 1rem;
  }
  .type-card {
    flex: 1;
    padding: 0.8rem;
    border: 2px solid #ccc;
    border-radius: 0.7rem;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
  }
  .type-card.active {
    border-color: #007bff;
    background: #e7f0ff;
  }
  .account-balance-info {
    margin-top: 0.3rem;
    font-size: 0.85rem;
    display: none;
  }
  .account-balance-info.show {
    display: block;
  }
  .amount-input-group {
    display: flex;
    align-items: center;
  }
  .amount-input-group .currency-symbol {
    padding: 0.5rem;
    background: #f1f1f1;
    border: 1px solid #ccc;
    border-right: 0;
    border-radius: 0.5rem 0 0 0.5rem;
  }
  .amount-input-group input {
    flex: 1;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  /* =======================
   Toasts
   ======================= */
  .toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 2000;
  }
  .toast {
    background: #333;
    color: #fff;
    padding: 0.7rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    min-width: 220px;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  .toast-success {
    background: green;
  }
  .toast-error {
    background: red;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(0);
  }

  /* =======================
   Chart
   ======================= */
  #balanceChart {
    width: 100% !important;
    height: 300px !important;
  }
</style>

<div class="transaction_app">
  <div class="container-fluid">
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header class="header fade-in">
      <div class="brand">
        <div class="logo">
          {% if user.profile.avatar %}
          <img
            src="{{ user.profile.avatar.url }}"
            alt="{{ user.username }}"
            style="
              width: 100%;
              height: 100%;
              border-radius: 50%;
              object-fit: cover;
            "
          />
          {% else %}
          <div class="avatar-placeholder">
            {{ user.profile.get_initials }}
          </div>
          {% endif %}
        </div>
        <h1>Transaction Dashboard</h1>
      </div>
      <div class="header-actions">
        <a href="{% url 'export_csv' %}" class="btn btn-secondary"
          >ðŸ“Š Export CSV</a
        >
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addTransactionModal"
        >
          âž• Add Transaction
        </button>
      </div>
    </header>

    <!-- Stats -->
    <section class="summary-stats">
      <div class="card stat-card fade-in">
        <h3>ðŸ’° Total Balance</h3>
        <div class="stat-value" id="totalBalance">â‚¦{{ total_balance }}</div>
        <div class="stat-trend">
          Across {{ accounts|length }} account{{ accounts|pluralize }}
        </div>
      </div>
      <div class="card stat-card fade-in *:hover:shadow-lg  active:bg-green-900">
        <h3>Income</h3>
        <div class="stat-value trend-up">
          â‚¦{{ monthly_income|floatformat:2 }}
        </div>
      </div>
      <div class="card stat-card fade-in  hover:shadow-lg  active:bg-red-900">
        <h3>Expenses</h3>
        <div class="stat-value trend-down">
          â‚¦{{ monthly_expenses|floatformat:2 }}
        </div>
      </div>
    </section>

    <!-- Accounts -->
    <section class="accounts-grid">
      {% for account in accounts %}
      <div class="card account-card fade-in">
        <div class="status-indicator"></div>
        <div class="account-header">
          <span class="account-name">{{ account.name }}</span>
          <span class="account-badge"
            >{{ account.get_account_type_display }}</span
          >
        </div>
        <div class="account-balance" id="account-{{ account.id }}-balance">
          â‚¦{{ account.balance|floatformat:2 }}
        </div>
        <div class="account-meta">Currency: 
          {{ account.currency }}</div>
      </div>
      {% endfor %}
    </section>

    <!-- Chart -->
    <div class="card content-panel fade-in">
      <h3>ðŸ“Š Balances</h3>
      <canvas id="balanceChart"></canvas>
    </div>

    <!-- Transactions -->
    <div class="card content-panel fade-in">
      <h3>ðŸ”„ Recent Transactions</h3>
      <div class="table-container">
        <table class="transactions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Account</th>
            </tr>
          </thead>
          <tbody id="transactionsTableBody">
            {% for transaction in recent_transactions %}
            <tr id="transaction-{{ transaction.id }}">
              <td>{{ transaction.date|date:"d M" }}</td>
              <td
                class="{% if transaction.transaction_type == 'income' %}transaction-income{% else %}transaction-expense{% endif %}"
              >
                {{ transaction.get_transaction_type_display }}
              </td>
              <td>{{ transaction.description }}</td>
              <td
                class="{% if transaction.transaction_type == 'income' %}amount-positive{% else %}amount-negative{% endif %}"
              >
                {% if transaction.transaction_type == 'income' %}â‚¦{% else %}-â‚¦
                {% endif %}
                {{ transaction.amount|floatformat:2 }}
              </td>
              <td>{{ transaction.account.name }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title">âž• Add Transaction</h1>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <form
          id="transactionForm"
          method="post"
          data-url="{% url 'add_transaction' %}"
        >
          {% csrf_token %}
          <div class="modal-body">
            <div class="form-group">
              <label>Type</label>
              <div class="transaction-type-cards">
                <div class="type-card expense" data-type="expense">
                  ðŸ“‰ Expense
                </div>
                <div class="type-card income" data-type="income">ðŸ“ˆ Income</div>
              </div>
              <input
                type="hidden"
                id="transactionType"
                name="transaction_type"
                required
              />
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label>Account</label>
                  <select
                    class="form-select"
                    id="account"
                    name="account"
                    required
                  >
                    <option value="">Select Account</option>
                    {% for account in accounts %}
                    <option
                      value="{{ account.id }}"
                      data-balance="{{ account.balance|floatformat:2 }}"
                    >
                      {{ account.name }}
                    </option>
                    {% endfor %}
                  </select>
                  <div class="account-balance-info" id="balanceInfo">
                    Current Balance: â‚¦<span id="currentBalance">0.00</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label>Amount</label>
                  <div class="amount-input-group">
                    <span class="currency-symbol">â‚¦</span>
                    <input
                      type="number"
                      class="form-control"
                      id="amount"
                      name="amount"
                      step="0.01"
                      min="0"
                      required
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea
                class="form-control"
                id="description"
                name="description"
                rows="2"
              ></textarea>
            </div>
            <div class="form-group">
              <label>Category</label>
              <select
                class="form-select"
                id="category"
                name="category"
                required
              >
                <option value="">Select</option>
                {% for value,label in transaction_categories %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label>Date</label>
              <input
                type="date"
                class="form-control"
                id="transactionDate"
                name="transaction_date"
                required
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              id="saveTransactionBtn"
            >
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function showToast(msg, type = "success") {
    const c = document.getElementById("toastContainer");
    if (!c) return;
    const t = document.createElement("div");
    t.className =
      "toast show " + (type === "error" ? "toast-error" : "toast-success");
    t.innerHTML = "<div>" + msg + "</div>";
    c.appendChild(t);
    setTimeout(() => {
      t.classList.remove("show");
      t.style.transform = "translateX(100%)";
      setTimeout(() => t.remove(), 350);
    }, 3500);
  }
  function setDefaultDate() {
    const i = document.getElementById("transactionDate");
    if (i) i.value = new Date().toISOString().split("T")[0];
  }
  function initializeAccountBalanceDisplay() {
    const s = document.getElementById("account");
    const info = document.getElementById("balanceInfo");
    const span = document.getElementById("currentBalance");
    if (!s) return;
    s.addEventListener("change", function () {
      const opt = this.options[this.selectedIndex];
      const b = opt?.dataset?.balance;
      if (b !== undefined) {
        span.textContent = parseFloat(b).toFixed(2);
        info.classList.add("show");
      } else {
        info.classList.remove("show");
      }
    });
  }
  function initializeTypeCardsToggle() {
    const cards = document.querySelectorAll(".type-card");
    const hidden = document.getElementById("transactionType");
    cards.forEach((card) => {
      card.addEventListener("click", () => {
        cards.forEach((c) => c.classList.remove("active"));
        card.classList.add("active");
        hidden.value = card.dataset.type;
      });
    });
    if (!hidden.value && cards.length) {
      cards[0].classList.add("active");
      hidden.value = cards[0].dataset.type;
    }
  }
  function initializeChart() {
    try {
      const el = document.getElementById("balanceChart");
      const dataEl = document.getElementById("chart-data");
      if (!el || !dataEl) return;
      const d = JSON.parse(dataEl.textContent || "{}");
      if (!d.labels) return;
      new Chart(el, {
        type: "line",
        data: {
          labels: d.labels,
          datasets: [
            {
              label: "Balances",
              data: d.data,
              fill: true,
              borderColor: "#3b82f6",
              backgroundColor: "rgba(59,130,246,0.2)",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true,
            },
            tooltip: {
            backgroundColor: "rgba(0,0,0,0.8)",
            titleColor: "#fff",
            bodyColor: "#fff",
            borderColor: "rgba(59,130,246,0.3)",
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: false,
            callbacks: {
              label: function (context) {
                return "â‚¦" + context.raw.toLocaleString();
              },
            },
          },
        },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: "Date",
              },
            },
            y: {
              display: true,
              title: {
                display: true,
                text: "Balance (â‚¦)",
              },
              beginAtZero: true,
            },
          },
          Animations: {
            tension: {
              duration: 1000,
              easing: "easeInOutQuart",
              from: 0.4,
              to: 0,
              loop: false,
            },
          },
        },

      });
    } catch (e) {
      console.log(e);
    }
  }
  async function submitTransactionForm(e) {
    e.preventDefault();
    const f = e.target;
    const url = f.dataset.url;
    const btn = document.getElementById("saveTransactionBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";
    const data = new FormData(f);
    const csrf = f.querySelector("input[name='csrfmiddlewaretoken']")?.value;
    try {
      const r = await fetch("{% url 'add_transaction' %}", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrf },
        body: data,
      });
      const j = await r.json();
      if (j.success) {
        const tb = document.getElementById("transactionsTableBody");
        if (tb && j.transaction) {
          const t = j.transaction;
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${t.date_display}</td><td>${t.transaction_type}</td><td>${t.description}</td><td>${t.amount}</td><td>${t.account_name}</td>`;
          tb.prepend(tr);
        }
        if (j.updated_account_id) {
          const b = document.getElementById(
            "account-" + j.updated_account_id + "-balance"
          );
          if (b)
            b.textContent =
              "â‚¦" + parseFloat(j.updated_account_balance).toFixed(2);
        }
        if (j.new_total_balance !== undefined) {
          document.getElementById("totalBalance").textContent =
            "â‚¦" + parseFloat(j.new_total_balance).toFixed(2);
        }
        showToast("Transaction saved");
        bootstrap.Modal.getInstance(
          document.getElementById("addTransactionModal")
        ).hide();
        f.reset();
      } else {
        showToast(j.message || "Error", "error");
      }
    } catch (err) {
      showToast("Network error", "error");
    } finally {
      btn.disabled = false;
      btn.textContent = "Save";
    }
  }
  document.addEventListener("DOMContentLoaded", () => {
    setDefaultDate();
    initializeAccountBalanceDisplay();
    initializeTypeCardsToggle();
    initializeChart();
    document
      .getElementById("transactionForm")
      .addEventListener("submit", submitTransactionForm);
  });
</script>
{% endblock %}
